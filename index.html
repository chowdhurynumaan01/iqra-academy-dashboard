<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQRA Academy of Michigan Student Data Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom CSS for animations and scrollbar hiding */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }\
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Basic print styles - to attempt vertical stacking.
           More robust print styles might be needed for complex layouts. */
        @media print {
            /* Universal print reset for consistent box model */
            * {
                box-sizing: border-box !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            html, body {
                width: 100%;
                min-height: 100vh; /* Ensure content flows */
                overflow: visible !important; /* Prevent hidden content */
                font-family: sans-serif; /* Ensure a readable font */
            }

            .container {
                max-width: 100% !important;
                padding: 0.5in !important; /* Add some print margin */
            }

            /* Header adjustments for print */
            header {
                margin-bottom: 0.5in !important;
            }
            h1 {
                font-size: 2.2em !important; /* Slightly smaller for print */
                margin-bottom: 0.2em !important;
            }
            p {
                font-size: 1.1em !important;
            }

            /* Force sections and their direct children to stack vertically */
            section.grid {
                display: block !important;
                width: 100% !important; /* Ensure section takes full print width */
                margin-bottom: 0.5in !important; /* Space between major sections */
            }
            section.grid > div {
                display: block !important;
                width: 100% !important;
                margin-bottom: 0.3in !important; /* Add space between stacked charts/cards */
                page-break-inside: avoid !important; /* Prevent breaking charts/cards across pages */
            }

            /* Ensure chart canvases and their containers adjust height */
            .h-80, .h-96 {
                height: auto !important;
                min-height: 200px !important; /* Ensure a minimum height for charts */
            }
            canvas {
                max-width: 100% !important; /* Ensure canvas fits within its container */
                height: auto !important;
                display: block !important; /* Ensure canvas behaves as a block element */
            }

            /* Adjust font sizes for print if necessary */
            h2 { font-size: 1.4em !important; margin-bottom: 0.2em !important; }

            /* Hide elements not needed for print */
            .no-print {
                display: none !important;
            }

            /* Ensure backgrounds and shadows print */
            body {
                -webkit-print-color-adjust: exact; /* Chrome, Safari */
                color-adjust: exact; /* Firefox */
            }
            .bg-white, .shadow-lg {
                background-color: #ffffff !important;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important; /* Lighter shadow for print */
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12 fade-in">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-4">IQRA Academy of Michigan Student Data Insights</h1>
            <p class="text-xl text-gray-600">Visualizing key student demographics and academic performance metrics.</p>
        </header>

        <section class="bg-white p-4 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row items-center justify-between space-y-2 md:space-y-0 md:space-x-4 fade-in no-print">
            <div class="text-sm text-gray-600">
                Your User ID: <span id="userIdDisplay" class="font-bold text-gray-800">Loading...</span>
            </div>
            <div id="appMessage" class="text-sm text-gray-600"></div>
            <div id="loadingIndicator" class="hidden">
                <i class="fas fa-spinner fa-spin text-indigo-600 text-xl"></i>
            </div>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 fade-in no-print">
            <label for="csvFileInput" class="block text-gray-700 font-semibold">Upload Student Data (CSV):</label>
            <input type="file" id="csvFileInput" accept=".csv" class="block w-full md:w-auto text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-purple-50 file:text-purple-700
                hover:file:bg-purple-100"/>
            <button id="loadCsvButton" class="px-6 py-2 rounded-full bg-indigo-600 text-white font-semibold shadow-md hover:bg-indigo-700 transition-colors duration-300">
                Load Data
            </button>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between card-hover transition-all duration-300 ease-in-out">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Total Students</p>
                    <p id="totalStudents" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <i class="fas fa-users text-purple-600 text-5xl opacity-20"></i>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between card-hover transition-all duration-300 ease-in-out">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Total Teachers</p>
                    <p id="totalTeachers" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <i class="fas fa-chalkboard-teacher text-indigo-600 text-5xl opacity-20"></i>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between card-hover transition-all duration-300 ease-in-out">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Irregular Students</p>
                    <p id="irregularStudents" class="text-4xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <i class="fas fa-exclamation-triangle text-red-600 text-5xl opacity-20"></i>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 xl:col-span-3 gap-6 mb-12">
            <div class="bg-white p-6 rounded-xl shadow-lg fade-in">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Level Distribution</h2>
                <div class="h-80">
                    <canvas id="levelChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg fade-in">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Teacher Distribution</h2>
                <div class="h-80">
                    <canvas id="teacherChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg fade-in">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Department Distribution</h2>
                <div class="h-80">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg fade-in">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Gender Distribution</h2>
                <div class="h-80">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg fade-in">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Regular vs. Irregular Students</h2>
                <div class="h-80">
                    <canvas id="regularIrregularChart"></canvas>
                </div>
            </div>
            <div class="lg:col-span-2 xl:col-span-3 bg-white p-6 rounded-xl shadow-lg fade-in">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Level by Gender</h2>
                <div class="h-96">
                    <canvas id="levelGenderChart"></canvas>
                </div>
            </div>
        </section>

        <footer class="text-center text-gray-500 text-sm mt-8">
            <p>&copy; 2023 IQRA Academy of Michigan. All rights reserved.</p>
        </footer>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Register the datalabels plugin globally BEFORE any chart instances are created.
        Chart.register(ChartDataLabels);

        // === TOGGLE FOR DATALABELS FORMATTING ===
        // Set this to `true` to show percentages on pie/doughnut charts,
        // and `false` to show actual numbers on all charts.
        let showPercentageOnPieDoughnut = false;
        // =======================================

        // YOUR FIREBASE CONFIGURATION - THIS HAS BEEN UPDATED WITH YOUR PROVIDED VALUES
        // This is crucial for connecting to YOUR Firebase project.
        const firebaseConfig = {
          apiKey: "AIzaSyAAg8GvVibxf1JeCzxsGuZXZhHRx1fRFzk",
          authDomain: "iqra-academy-dashboard-backend.firebaseapp.com",
          projectId: "iqra-academy-dashboard-backend",
          storageBucket: "iqra-academy-dashboard-backend.firebasestorage.app",
          messagingSenderId: "297544551827",
          appId: "1:297544551827:web:aced8762aef12495d42c66",
          measurementId: "G-HH530TRWPF"
        };


        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null; // To store the authenticated user ID

        // Use a consistent app ID for the Firestore path on GitHub Pages.
        // This should be a unique string for your public dashboard.
        const githubAppId = "iqra-dashboard-public";
        const studentDataDocRef = doc(db, `artifacts/${githubAppId}/public/data/student_data/main_data`); // Public data path

        // DOM Elements for messages and loading
        const appMessageDiv = document.getElementById('appMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        /**
         * Displays a message to the user.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message (e.g., 'green', 'red', 'orange').
         */
        function displayMessage(message, type = 'gray') {
            appMessageDiv.textContent = message;
            appMessageDiv.className = `text-sm mt-2 md:mt-0 text-${type}-600`;
        }

        /**
         * Shows or hides the loading indicator.
         * @param {boolean} show - True to show, false to hide.
         */
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Initial sample data for immediate display if no data is in Firestore or uploaded yet.
        // This addresses the "Missing expected headers" error on initial load.
        let currentRawData = `LEVEL,TEACHER,GENDER,NAME,PARENTS NAME,CONTACT INFO,RN,Department
2,MD Abdur Rashid,BOYS,Mohammed I. Khan,M. HERON KHAN,313 455 1008,1,WEEKEND
2,MD Abdur Rashid,BOYS,Nazmul Shaheen,KAMRUL SHAHEEN,586 303 6606,2,WEEKEND
2,MD Abdur Rashid,BOYS,Maaz Usman,USMAN AHMED,313 661 9890,3,WEEKEND
3,Numaan Chowdhury,BOYS,Mohd. Ahad Abid,ABDUL AHAD,586 354 5713,1,WEEKEND
4,Hafij Badruzzaman,GIRLS,Sabiha Rahman,WALIUR RAHMAN,313 598 6417,1,WEEKEND
1A,Wahidur M Rahman,BOYS,Radeen Noor,ROMAN NOOR,313 615 6654,1,WEEKEND
1B,Adannan Chowdhury,GIRLS,Farhan Uddin,JAMAL UDDIN,313 443 6329,1,WEEKEND
1C,Tahmidur R Kawsar,BOYS,Adyan Islam,FAKHRUL ISLAM,313 603 1532,1,WEEKEND
2,Raesa Chowdhury,GIRLS,Humaira Kazi,KAZI SHAYEK MIAH,313 312 3781,1,WEEKEND
3,Asma Alsarrah,GIRLS,Abia Mahreen,KOYES AHMED,313 685 2777,1,WEEKEND
4,Fairoz Alsaidi,GIRLS,Farihah Islam,KAMRUL ISLAM,313 303 6660,2,WEEKEND
1A,Umaiza Hussain,GIRLS,Zeemal Tahir,MOHD. TAHIR,248 361 8881,1,WEEKEND
1B,Fahmidah Aniqa,GIRLS,Samiha Ahmed,MOHD. SUHEL AHMED,313 240 2881,1,WEEKEND
1C,Habiba Islam,GIRLS,Manha Bint Ali,M. SHAJAHAN ALI,404 665 6720,1,WEEKEND
0,Data unavailable,BOYS,ARSHAN SUBHAN,NAZMIN SUBHAN,818 918 1527,0,EVENING
0,Data unavailable,GIRLS,MAIMUNA MARIYAM,ABUL ALA CHY,313 603 2039,0,0
`;

        let studentsData = []; // Global variable to hold parsed student data

        /**
         * Parses CSV student data to extract relevant fields (Level, Teacher, Gender, Name, Parents Name, Contact Info, RN, Department).
         * This function expects the first line of the rawData to be a header row.
         * @param {string} rawData - The raw CSV text data containing student information.
         * @returns {Array<Object>} An array of student objects with parsed fields.
         */
        function parseStudentData(rawData) {
            const lines = rawData.trim().split('\n');
            if (lines.length === 0) {
                console.error("No data found in rawData.");
                return [];
            }

            // Extract headers from the first line and clean them
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            console.log("Parsed Headers:", headers);

            // Define expected headers for validation and mapping
            const expectedHeaders = ['LEVEL', 'TEACHER', 'GENDER', 'NAME', 'PARENTS NAME', 'CONTACT INFO', 'RN', 'Department'];

            // Validate if all expected headers are present
            const missingHeaders = expectedHeaders.filter(header => !headers.includes(header));
            if (missingHeaders.length > 0) {
                console.error(`Missing expected headers: ${missingHeaders.join(', ')}. Please ensure your CSV has these columns.`);
                // If critical headers are missing, return empty array to prevent chart errors
                return [];
            }

            const students = [];
            // Process data rows starting from the second line
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue; // Skip empty lines

                // Split the line by comma, handling quoted fields
                // This regex handles commas inside double quotes
                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];

                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed line (column count mismatch): ${line}`);
                    continue;
                }

                const student = {};
                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    let value = values[j].trim();
                    // Remove quotes from quoted fields
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.substring(1, value.length - 1);
                    }
                    student[header] = value;
                }

                // Normalize department, level, and gender to uppercase for consistent counting
                const normalizedDepartment = student['Department'] ? student['Department'].trim().toUpperCase() : '';
                const normalizedLevel = student.LEVEL ? student.LEVEL.trim().toUpperCase() : '';
                const normalizedGender = student.GENDER ? student.GENDER.trim().toUpperCase() : '';


                // Only push student if it has at least the core data for charts
                if (normalizedLevel && student.TEACHER && normalizedGender) {
                    students.push({
                        level: normalizedLevel, // Use normalized level
                        teacher: student.TEACHER,
                        gender: normalizedGender, // Use normalized gender
                        name: student.NAME || '', // Optional fields
                        parentsName: student['PARENTS NAME'] || '',
                        contactInfo: student['CONTACT INFO'] || '',
                        rn: student.RN || '', // Add RN field
                        department: (normalizedDepartment !== '0') ? normalizedDepartment : '' // Normalize '0' to empty string
                    });
                } else {
                    console.warn("Skipping line due to missing core data (LEVEL, TEACHER, or GENDER):", student);
                }
            }
            console.log("Total Parsed Students:", students.length);
            return students;
        }

        // Chart instances storage
        let levelChartInstance, teacherChartInstance, levelGenderChartInstance, departmentChartInstance, genderChartInstance, regularIrregularChartInstance;

        /**
         * Renders all charts based on the provided student data.
         * @param {Array<Object>} studentsData - The array of parsed student objects.
         */
        function renderCharts(studentsData) {
            // Calculate data for charts
            const levelDistribution = {};
            const teacherDistribution = {};
            const levelGenderDistribution = {};
            const departmentDistribution = {};
            const genderDistribution = { BOYS: 0, GIRLS: 0 };
            let regularStudentsCount = 0;
            let irregularStudentsCount = 0;

            studentsData.forEach(student => {
                levelDistribution[student.level] = (levelDistribution[student.level] || 0) + 1;
                teacherDistribution[student.teacher] = (teacherDistribution[student.teacher] || 0) + 1;

                if (!levelGenderDistribution[student.level]) {
                    levelGenderDistribution[student.level] = { BOYS: 0, GIRLS: 0 };
                }
                levelGenderDistribution[student.level][student.gender] = (levelGenderDistribution[student.level][student.gender] || 0) + 1;

                if (student.department && student.department !== '') {
                    departmentDistribution[student.department] = (departmentDistribution[student.department] || 0) + 1;
                }

                if (student.gender === 'BOYS' || student.gender === 'MALE') {
                    genderDistribution['BOYS']++;
                } else if (student.gender === 'GIRLS' || student.gender === 'FEMALE') {
                    genderDistribution['GIRLS']++;
                }

                const rnValue = student.rn.trim();
                if (rnValue === '' || rnValue === '0' || rnValue === 'Data unavailable') {
                    irregularStudentsCount++;
                } else {
                    regularStudentsCount++;
                }
            });

            // Prepare data for Chart.js
            const levelLabels = Object.keys(levelDistribution).sort((a, b) => {
                const order = ['0', '1A', '1B', '1C', '2', '3', '4'];
                return order.indexOf(a) - order.indexOf(b);
            });
            const levelData = levelLabels.map(label => levelDistribution[label]);

            const teacherLabels = Object.keys(teacherDistribution).sort();
            const teacherData = teacherLabels.map(label => teacherDistribution[label]);

            const levelGenderLabels = Object.keys(levelGenderDistribution).sort((a, b) => {
                const order = ['0', '1A', '1B', '1C', '2', '3', '4'];
                return order.indexOf(a) - order.indexOf(b);
            });
            const levelGenderBoysData = levelGenderLabels.map(label => levelGenderDistribution[label].BOYS || 0);
            const levelGenderGirlsData = levelGenderLabels.map(label => levelGenderDistribution[label].GIRLS || 0);

            const departmentLabels = Object.keys(departmentDistribution).sort();
            const departmentData = departmentLabels.map(label => departmentDistribution[label]);

            const genderLabels = ['Boys', 'Girls'];
            const genderData = [genderDistribution.BOYS, genderDistribution.GIRLS];

            const regularIrregularLabels = ['Regular Students', 'Irregular Students'];
            const regularIrregularData = [regularStudentsCount, irregularStudentsCount];

            // Update Key Metrics
            document.getElementById('totalStudents').textContent = studentsData.length;
            document.getElementById('totalTeachers').textContent = teacherLabels.length;
            document.getElementById('irregularStudents').textContent = irregularStudentsCount;

            // Helper function to create chart options with datalabels
            function getChartOptions(titleText, pluginsOptions = {}, scalesOptions = {}) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: titleText ? true : false,
                            text: titleText
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            },
                            formatter: (value, context) => {
                                if (showPercentageOnPieDoughnut && (context.chart.config.type === 'pie' || context.chart.config.type === 'doughnut')) {
                                    const sum = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (sum > 0) ? (value * 100 / sum).toFixed(1) + '%' : '0%';
                                    return percentage;
                                }
                                return value;
                            }
                        },
                        ...pluginsOptions
                    },
                    scales: scalesOptions
                };
            }

            // Destroy existing chart instances before creating new ones to prevent memory leaks and conflicts
            if (levelChartInstance) levelChartInstance.destroy();
            if (teacherChartInstance) teacherChartInstance.destroy();
            if (levelGenderChartInstance) levelGenderChartInstance.destroy();
            if (departmentChartInstance) departmentChartInstance.destroy();
            if (genderChartInstance) genderChartInstance.destroy();
            if (regularIrregularChartInstance) regularIrregularChartInstance.destroy();

            // Level Distribution Chart
            const levelCtx = document.getElementById('levelChart').getContext('2d');
            levelChartInstance = new Chart(levelCtx, {
                type: 'pie',
                data: {
                    labels: levelLabels,
                    datasets: [{
                        data: levelData,
                        backgroundColor: [
                            '#6366F1', '#818CF8', '#A5B4FC', '#C7D2FE',
                            '#E0E7FF', '#F3F4F6', '#A78BFA'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: getChartOptions('Student Level Distribution')
            });

            // Teacher Distribution Chart
            const teacherCtx = document.getElementById('teacherChart').getContext('2d');
            teacherChartInstance = new Chart(teacherCtx, {
                type: 'bar',
                data: {
                    labels: teacherLabels,
                    datasets: [{
                        label: 'Number of Students',
                        data: teacherData,
                        backgroundColor: '#10B981',
                        borderColor: '#059669',
                        borderWidth: 1
                    }]
                },
                options: getChartOptions(
                    'Student Distribution by Teacher',
                    { legend: { display: false } },
                    {
                        x: { beginAtZero: true, title: { display: true, text: 'Number of Students' } },
                        y: { title: { display: true, text: 'Teacher' } }
                    }
                )
            });

            // Level by Gender Chart
            const levelGenderCtx = document.getElementById('levelGenderChart').getContext('2d');
            levelGenderChartInstance = new Chart(levelGenderCtx, {
                type: 'bar',
                data: {
                    labels: levelGenderLabels,
                    datasets: [
                        {
                            label: 'Boys',
                            data: levelGenderBoysData,
                            backgroundColor: '#4F46E5'
                        },
                        {
                            label: 'Girls',
                            data: levelGenderGirlsData,
                            backgroundColor: '#EC4899'
                        }
                    ]
                },
                options: getChartOptions(
                    'Level by Gender Distribution',
                    {},
                    {
                        x: { stacked: false, title: { display: true, text: 'Level' } },
                        y: { stacked: false, beginAtZero: true, title: { display: true, text: 'Number of Students' } }
                    }
                )
            });

            // Department Distribution Chart
            const departmentCtx = document.getElementById('departmentChart').getContext('2d');
            departmentChartInstance = new Chart(departmentCtx, {
                type: 'doughnut',
                data: {
                    labels: departmentLabels,
                    datasets: [{
                        data: departmentData,
                        backgroundColor: [
                            '#F59E0B', '#6366F1', '#10B981', '#EF4444'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: getChartOptions('Department Distribution')
            });

            // Gender Distribution Chart
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            genderChartInstance = new Chart(genderCtx, {
                type: 'pie',
                data: {
                    labels: genderLabels,
                    datasets: [{
                        data: genderData,
                        backgroundColor: [
                            '#3B82F6',
                            '#EC4899'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: getChartOptions('Overall Gender Distribution')
            });

            // Regular vs. Irregular Students Chart
            const regularIrregularCtx = document.getElementById('regularIrregularChart').getContext('2d');
            regularIrregularChartInstance = new Chart(regularIrregularCtx, {
                type: 'doughnut',
                data: {
                    labels: regularIrregularLabels,
                    datasets: [{
                        data: regularIrregularData,
                        backgroundColor: [
                            '#22C55E',
                            '#EF4444'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: getChartOptions('Regular vs. Irregular Students')
            });
        }

        /**
         * Saves the provided raw CSV data string to Firestore.
         * @param {string} data - The raw CSV data string to save.
         */
        async function saveDataToFirestore(data) {
            showLoading(true);
            displayMessage('Saving data to the cloud...', 'orange');
            try {
                await setDoc(studentDataDocRef, { csvData: data, timestamp: new Date().toISOString() });
                displayMessage('Data saved successfully!', 'green');
            } catch (error) {
                console.error("Error writing document:", error);
                displayMessage('Error saving data. Please try again.', 'red');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Sets up a real-time listener for student data from Firestore.
         * This function is called after successful authentication.
         */
        function setupFirestoreListener() {
            showLoading(true);
            displayMessage('Fetching latest data...', 'gray');
            onSnapshot(studentDataDocRef, (docSnap) => {
                showLoading(false);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && data.csvData) {
                        currentRawData = data.csvData;
                        studentsData = parseStudentData(currentRawData);
                        if (studentsData.length > 0) {
                            renderCharts(studentsData);
                            displayMessage('Data updated in real-time!', 'green');
                        } else {
                            displayMessage('No valid student data found in the cloud document. Please upload a valid CSV.', 'red');
                        }
                    } else {
                        // Document exists but has no csvData, possibly a new document
                        displayMessage('No student data found in the cloud. Upload a CSV to get started!', 'orange');
                        // Render with empty data if no CSV data is found
                        renderCharts([]);
                    }
                } else {
                    // Document does not exist, it's the first time
                    displayMessage('No student data found in the cloud. Upload a CSV to get started!', 'orange');
                    // Render with empty data if document doesn't exist
                    renderCharts([]);
                }
            }, (error) => {
                showLoading(false);
                console.error("Error listening to document:", error);
                displayMessage('Error fetching real-time updates. Check console for details (e.g., Firebase security rules).', 'red');
            });
        }

        /**
         * Handles Firebase authentication and then sets up the Firestore listener.
         */
        async function authenticateAndLoad() {
            showLoading(true);
            displayMessage('Authenticating...', 'gray');
            try {
                // __initial_auth_token is specific to the Canvas environment.
                // On GitHub Pages, we'll rely on anonymous sign-in.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('userIdDisplay').textContent = currentUserId;
                console.log("Authenticated as:", currentUserId);
                setupFirestoreListener(); // Setup listener after auth
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                displayMessage("Authentication failed. Please ensure your Firebase API keys are correctly configured in the code and services are enabled in Firebase console.", 'red');
                showLoading(false);
            }
        }

        // Event listener for file input change
        document.getElementById('loadCsvButton').addEventListener('click', () => {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];

            if (file) {
                if (file.type !== 'text/csv') {
                    displayMessage('Please upload a CSV file.', 'red');
                    return;
                }

                displayMessage('Reading file...', 'orange');
                showLoading(true);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const newRawData = e.target.result;
                        const parsedStudents = parseStudentData(newRawData);
                        if (parsedStudents.length > 0) {
                            // Save the new data to Firestore
                            await saveDataToFirestore(newRawData);
                            // The onSnapshot listener will then trigger renderCharts with the new data
                        } else {
                            displayMessage('No valid student data found in the CSV. Not saving to cloud.', 'red');
                        }
                    } catch (error) {
                        console.error("Error processing CSV:", error);
                        displayMessage('Error processing file. Please check console for details.', 'red');
                    } finally {
                        showLoading(false);
                    }
                };
                reader.onerror = () => {
                    displayMessage('Error reading file.', 'red');
                    showLoading(false);
                };
                reader.readAsText(file);
            } else {
                displayMessage('Please select a CSV file to upload.', 'red');
            }
        });

        // Parse the initial embedded data and render charts on load,
        // then initiate Firebase authentication and real-time listening.
        studentsData = parseStudentData(currentRawData);
        renderCharts(studentsData);
        authenticateAndLoad();

        // Ensure the initial message is cleared or set appropriately after initial load
        // This is handled by setupFirestoreListener or authentication status
    </script>
</body>
</html>
