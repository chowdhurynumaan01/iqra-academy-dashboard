<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQRA Academy of Michigan Student Data Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom CSS for animations and scrollbar hiding */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }\
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Basic print styles - to attempt vertical stacking.
           More robust print styles might be needed for complex layouts. */
        @media print {
            /* Universal print reset for consistent box model */
            * {
                box-sizing: border-box !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            html, body {
                width: 100%;
                min-height: 100vh; /* Ensure content flows */
                overflow: visible !important; /* Prevent hidden content */
                font-family: sans-serif; /* Ensure a readable font */
            }

            .container {
                max-width: 100% !important;
                padding: 0.5in !important; /* Add some print margin */
            }

            /* Header adjustments for print */
            header {
                margin-bottom: 0.5in !important;
            }
            h1 {
                font-size: 2.2em !important; /* Slightly smaller for print */
                margin-bottom: 0.2em !important;
            }
            p {
                font-size: 1.1em !important;
            }

            /* Force sections and their direct children to stack vertically */
            section.grid {
                display: block !important;
                width: 100% !important; /* Ensure section takes full print width */
                margin-bottom: 0.5in !important; /* Space between major sections */
            }
            section.grid > div {
                display: block !important;
                width: 100% !important;
                margin-bottom: 0.3in !important; /* Add space between stacked charts/cards */
                page-break-inside: avoid !important; /* Prevent breaking charts/cards across pages */
            }

            /* Ensure chart canvases and their containers adjust height */
            .h-80, .h-96 {
                height: auto !important;
                min-height: 200px !important; /* Ensure a minimum height for charts */
            }
            canvas {
                max-width: 100% !important; /* Ensure canvas fits within its container */
                height: auto !important;
                display: block !important; /* Ensure canvas behaves as a block element */
            }

            /* Adjust font sizes for print if necessary */
            h2 { font-size: 1.4em !important; margin-bottom: 0.2em !important; }

            /* Hide elements not needed for print */
            .no-print {
                display: none !important;
            }

            /* Ensure backgrounds and shadows print */
            body {
                -webkit-print-color-adjust: exact; /* Chrome, Safari */
                color-adjust: exact; /* Firefox */
            }
            .bg-white, .shadow-lg {
                background-color: #ffffff !important;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important; /* Lighter shadow for print */
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12 fade-in">
            <h1 class="text-5xl font-extrabold text-gray-900 mb-4">IQRA Academy of Michigan Student Data Insights</h1>
            <p class="text-xl text-gray-600">Visualizing key student demographics and academic performance metrics.</p>
            <div class="w-24 h-1 bg-indigo-500 mx-auto mt-4 rounded-full"></div>
        </header>

        <section class="bg-white p-4 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row items-center justify-between space-y-2 md:space-y-0 md:space-x-4 fade-in no-print">
            <div class="text-sm text-gray-600">
                Your User ID: <span id="userIdDisplay" class="font-bold text-gray-800">Loading...</span>
            </div>
            <div id="appMessage" class="text-sm text-gray-600"></div>
            <div id="loadingIndicator" class="hidden">
                <i class="fas fa-spinner fa-spin text-indigo-600 text-xl"></i>
            </div>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 fade-in no-print">
            <label for="csvFileInput" class="block text-gray-700 font-semibold">Upload Student Data (CSV):</label>
            <input type="file" id="csvFileInput" accept=".csv" class="block w-full md:w-auto text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-purple-50 file:text-purple-700
                hover:file:bg-purple-100"/>
            <button id="loadCsvButton" class="px-6 py-2 rounded-full bg-indigo-600 text-white font-semibold shadow-md hover:bg-indigo-700 transition-colors duration-300">
                Load Data
            </button>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12 fade-in">
            <div class="bg-white rounded-xl shadow-md p-6 transition-all duration-300 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-indigo-100 text-indigo-600 mr-4">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Total Students</p>
                        <h3 id="totalStudents" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 transition-all duration-300 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600 mr-4">
                        <i class="fas fa-male text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Male Students</p>
                        <h3 id="maleStudents" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 transition-all duration-300 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-pink-100 text-pink-600 mr-4">
                        <i class="fas fa-female text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Female Students</p>
                        <h3 id="femaleStudents" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 transition-all duration-300 card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600 mr-4">
                        <i class="fas fa-calendar-alt text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-500">Weekend Program</p>
                        <h3 id="weekendProgram" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            <div class="bg-white rounded-xl shadow-md p-6 fade-in lg:col-span-1">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-venus-mars text-indigo-500 mr-2"></i>
                    Gender Distribution
                </h2>
                <div class="h-64">
                    <canvas id="genderChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <p id="genderInsight">Loading insights...</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 fade-in lg:col-span-1">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-calendar-week text-blue-500 mr-2"></i>
                    Program Distribution
                </h2>
                <div class="h-64">
                    <canvas id="programChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <p id="programInsight">Loading insights...</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 fade-in lg:col-span-1">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-layer-group text-green-500 mr-2"></i>
                    Class Level Distribution
                </h2>
                <div class="h-64">
                    <canvas id="levelChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <p id="levelInsight">Loading insights...</p>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-md p-6 mb-12 fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-users-between-lines text-purple-500 mr-2"></i>
                Family Groupings Analysis
            </h2>
            <div class="overflow-x-auto scrollbar-hide">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Children Count</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender Mix</th>
                        </tr>
                    </thead>
                    <tbody id="familyGroupingsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">No family data available.</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-sm text-gray-600">
                <p id="familyInsight">Loading insights...</p>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <div class="bg-white rounded-xl shadow-md p-6 fade-in">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-building text-orange-500 mr-2"></i>
                    Department Distribution
                </h2>
                <div class="h-64">
                    <canvas id="departmentChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <p id="departmentInsight">Loading insights...</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 fade-in">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-bar text-teal-500 mr-2"></i>
                    Level Distribution by Gender
                </h2>
                <div class="h-64">
                    <canvas id="levelGenderChart"></canvas>
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <p id="levelGenderInsight">Loading insights...</p>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-md p-6 mb-12 fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-user-friends text-red-500 mr-2"></i>
                Top Parents by Number of Children Enrolled
            </h2>
            <div id="topParentsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-gray-50 rounded-lg p-4 text-center text-gray-500 col-span-full">No top parent data available.</div>
            </div>
            <div class="mt-4 text-sm text-gray-600">
                <p id="topParentsInsight">Loading insights...</p>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-md p-6 mb-12 fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-table text-amber-500 mr-2"></i>
                Student Data Overview
            </h2>
            <div class="overflow-x-auto scrollbar-hide">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent</th>
                        </tr>
                    </thead>
                    <tbody id="studentDataTableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">No student data available.</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-between items-center no-print">
                <span id="paginationInfo" class="text-sm text-gray-600">Showing 0 to 0 of 0 entries</span>
                <div class="flex space-x-2">
                    <button id="prevPageButton" class="px-3 py-1 bg-gray-200 rounded-md text-sm disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <div id="paginationButtons" class="flex space-x-2">
                        </div>
                    <button id="nextPageButton" class="px-3 py-1 bg-gray-200 rounded-md text-sm disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                </div>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-md p-6 mb-12 fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                Key Insights from the Data
            </h2>
            <div id="keyInsightsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2 flex items-center">
                        <i class="fas fa-balance-scale text-blue-500 mr-2"></i>
                        Gender Balance
                    </h3>
                    <p id="insightGender" class="text-sm text-gray-700">Loading insights...</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-2 flex items-center">
                        <i class="fas fa-home text-green-500 mr-2"></i>
                        Family Engagement
                    </h3>
                    <p id="insightFamily" class="text-sm text-gray-700">Loading insights...</p>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <h3 class="font-semibold text-purple-800 mb-2 flex items-center">
                        <i class="fas fa-chalkboard-teacher text-purple-500 mr-2"></i>
                        Program Popularity
                    </h3>
                    <p id="insightProgram" class="text-sm text-gray-700">Loading insights...</p>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <h3 class="font-semibold text-orange-800 mb-2 flex items-center">
                        <i class="fas fa-user-graduate text-orange-500 mr-2"></i>
                        Level Distribution
                    </h3>
                    <p id="insightLevel" class="text-sm text-gray-700">Loading insights...</p>
                </div>
            </div>
        </section>

        <footer class="text-center py-6 text-gray-500 text-sm">
            <p>&copy; 2023 IQRA Academy of Michigan. All rights reserved.</p>
            <p class="mt-1">Data last updated: <span id="lastUpdated">N/A</span></p>
        </footer>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Register the datalabels plugin globally BEFORE any chart instances are created.
        Chart.register(ChartDataLabels);

        // === TOGGLE FOR DATALABELS FORMATTING ===
        // Set this to `true` to show percentages on pie/doughnut charts,
        // and `false` to show actual numbers on all charts.
        let showPercentageOnPieDoughnut = false;
        // =======================================

        // YOUR FIREBASE CONFIGURATION - THIS HAS BEEN UPDATED WITH YOUR PROVIDED VALUES
        // This is crucial for connecting to YOUR Firebase project.
        const firebaseConfig = {
          apiKey: "AIzaSyAAg8GvVibxf1JeCzxsGuZXZhHRx1fRFzk",
          authDomain: "iqra-academy-dashboard-backend.firebaseapp.com",
          projectId: "iqra-academy-dashboard-backend",
          storageBucket: "iqra-academy-dashboard-backend.firebasestorage.app",
          messagingSenderId: "297544551827",
          appId: "1:297544551827:web:aced8762aef12495d42c66",
          measurementId: "G-HH530TRWPF"
        };

        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserId = null; // To store the authenticated user ID

        // Use a consistent app ID for the Firestore path on GitHub Pages.
        // This should be a unique string for your public dashboard.
        const githubAppId = "iqra-dashboard-public";
        const studentDataDocRef = doc(db, `artifacts/${githubAppId}/public/data/student_data/main_data`); // Public data path

        // DOM Elements for messages and loading
        const appMessageDiv = document.getElementById('appMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Pagination variables
        const rowsPerPage = 10;
        let currentPage = 1;
        let totalPages = 1;

        /**
         * Displays a message to the user.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message (e.g., 'green', 'red', 'orange').
         */
        function displayMessage(message, type = 'gray') {
            appMessageDiv.textContent = message;
            appMessageDiv.className = `text-sm mt-2 md:mt-0 text-${type}-600`;
        }

        /**
         * Shows or hides the loading indicator.
         * @param {boolean} show - True to show, false to hide.
         */
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Initial sample data for immediate display if no data is in Firestore or uploaded yet.
        // This addresses the "Missing expected headers" error on initial load.
        let currentRawData = `LEVEL,TEACHER,GENDER,NAME,PARENTS NAME,CONTACT INFO,RN,Department
2,MD Abdur Rashid,BOYS,Mohammed I. Khan,M. HERON KHAN,313 455 1008,1,WEEKEND
2,MD Abdur Rashid,BOYS,Nazmul Shaheen,KAMRUL SHAHEEN,586 303 6606,2,WEEKEND
2,MD Abdur Rashid,BOYS,Maaz Usman,USMAN AHMED,313 661 9890,3,WEEKEND
3,Numaan Chowdhury,BOYS,Mohd. Ahad Abid,ABDUL AHAD,586 354 5713,1,WEEKEND
4,Hafij Badruzzaman,GIRLS,Sabiha Rahman,WALIUR RAHMAN,313 598 6417,1,WEEKEND
1A,Wahidur M Rahman,BOYS,Radeen Noor,ROMAN NOOR,313 615 6654,1,WEEKEND
1B,Adannan Chowdhury,GIRLS,Farhan Uddin,JAMAL UDDIN,313 443 6329,1,WEEKEND
1C,Tahmidur R Kawsar,BOYS,Adyan Islam,FAKHRUL ISLAM,313 603 1532,1,WEEKEND
2,Raesa Chowdhury,GIRLS,Humaira Kazi,KAZI SHAYEK MIAH,313 312 3781,1,WEEKEND
3,Asma Alsarrah,GIRLS,Abia Mahreen,KOYES AHMED,313 685 2777,1,WEEKEND
4,Fairoz Alsaidi,GIRLS,Farihah Islam,KAMRUL ISLAM,313 303 6660,2,WEEKEND
1A,Umaiza Hussain,GIRLS,Zeemal Tahir,MOHD. TAHIR,248 361 8881,1,WEEKEND
1B,Fahmidah Aniqa,GIRLS,Samiha Ahmed,MOHD. SUHEL AHMED,313 240 2881,1,WEEKEND
1C,Habiba Islam,GIRLS,Manha Bint Ali,M. SHAJAHAN ALI,404 665 6720,1,WEEKEND
0,Data unavailable,BOYS,ARSHAN SUBHAN,NAZMIN SUBHAN,818 918 1527,0,EVENING
0,Data unavailable,GIRLS,MAIMUNA MARIYAM,ABUL ALA CHY,313 603 2039,0,0
`;

        let studentsData = []; // Global variable to hold parsed student data
        let familyGroupingsData = []; // Global variable for family data

        /**
         * Parses CSV student data to extract relevant fields.
         * This function expects the first line of the rawData to be a header row.
         * @param {string} rawData - The raw CSV text data containing student information.
         * @returns {Array<Object>} An array of student objects with parsed fields.
         */
        function parseStudentData(rawData) {
            const lines = rawData.trim().split('\n');
            if (lines.length === 0) {
                console.warn("No data found in rawData.");
                return [];
            }

            // Extract headers from the first line and clean them
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            console.log("Parsed Headers:", headers);

            // Define expected headers for validation and mapping
            const expectedHeaders = ['LEVEL', 'TEACHER', 'GENDER', 'NAME', 'PARENTS NAME', 'CONTACT INFO', 'RN', 'Department'];

            const missingHeaders = expectedHeaders.filter(header => !headers.includes(header));
            if (missingHeaders.length > 0) {
                console.error(`Missing expected headers: ${missingHeaders.join(', ')}. Please ensure your CSV has these columns.`);
                displayMessage(`CSV Error: Missing columns - ${missingHeaders.join(', ')}.`, 'red');
                return [];
            }

            const students = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;

                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];

                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed line (column count mismatch): ${line}`);
                    continue;
                }

                const student = {};
                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    let value = values[j].trim();
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.substring(1, value.length - 1);
                    }
                    student[header] = value;
                }

                // Normalize data for consistency
                const normalizedDepartment = student['Department'] ? student['Department'].trim().toUpperCase() : '';
                const normalizedLevel = student.LEVEL ? student.LEVEL.trim().toUpperCase() : '';
                const normalizedGender = student.GENDER ? student.GENDER.trim().toUpperCase() : '';
                const normalizedParentName = student['PARENTS NAME'] ? student['PARENTS NAME'].trim().toUpperCase() : '';

                if (normalizedLevel && student.TEACHER && normalizedGender && normalizedParentName) {
                    students.push({
                        level: normalizedLevel,
                        teacher: student.TEACHER,
                        gender: (normalizedGender === 'BOYS' || normalizedGender === 'MALE') ? 'BOYS' : ((normalizedGender === 'GIRLS' || normalizedGender === 'FEMALE') ? 'GIRLS' : 'UNKNOWN'),
                        name: student.NAME || '',
                        parentsName: normalizedParentName,
                        contactInfo: student['CONTACT INFO'] || '',
                        rn: student.RN || '',
                        department: (normalizedDepartment !== '0') ? normalizedDepartment : ''
                    });
                } else {
                    console.warn("Skipping line due to missing core data (LEVEL, TEACHER, GENDER, or PARENTS NAME):", student);
                }
            }
            console.log("Total Parsed Students:", students.length);
            return students;
        }

        // Chart instances storage
        let genderChartInstance, programChartInstance, levelChartInstance, departmentChartInstance, levelGenderChartInstance;

        /**
         * Renders all charts and updates summary cards based on the provided student data.
         * @param {Array<Object>} studentsData - The array of parsed student objects.
         */
        function renderDashboard(studentsData) {
            // Calculate summary metrics
            const totalStudentsCount = studentsData.length;
            let maleStudentsCount = 0;
            let femaleStudentsCount = 0;
            let weekendProgramCount = 0;
            let irregularStudentsCount = 0;

            const levelDistribution = {};
            const teacherDistribution = {}; // Not used in new charts, but good to keep for potential future use
            const levelGenderDistribution = {};
            const departmentDistribution = {};
            const genderDistribution = { BOYS: 0, GIRLS: 0 };

            const familyGroups = {}; // For family groupings and top parents

            studentsData.forEach(student => {
                // Gender counts
                if (student.gender === 'BOYS') {
                    maleStudentsCount++;
                    genderDistribution['BOYS']++;
                } else if (student.gender === 'GIRLS') {
                    femaleStudentsCount++;
                    genderDistribution['GIRLS']++;
                }

                // Program/Department counts
                if (student.department === 'WEEKEND') {
                    weekendProgramCount++;
                }
                if (student.department && student.department !== '') {
                    departmentDistribution[student.department] = (departmentDistribution[student.department] || 0) + 1;
                }

                // Level distribution
                levelDistribution[student.level] = (levelDistribution[student.level] || 0) + 1;

                // Level by Gender
                if (!levelGenderDistribution[student.level]) {
                    levelGenderDistribution[student.level] = { BOYS: 0, GIRLS: 0 };
                }
                if (student.gender === 'BOYS') {
                    levelGenderDistribution[student.level]['BOYS']++;
                } else if (student.gender === 'GIRLS') {
                    levelGenderDistribution[student.level]['GIRLS']++;
                }

                // Irregular students
                const rnValue = String(student.rn).trim(); // Ensure RN is treated as string for comparison
                if (rnValue === '' || rnValue === '0' || rnValue.toLowerCase() === 'data unavailable') {
                    irregularStudentsCount++;
                }

                // Family Groupings
                if (student.parentsName && student.parentsName !== '0' && student.parentsName.toLowerCase() !== 'data unavailable') {
                    if (!familyGroups[student.parentsName]) {
                        familyGroups[student.parentsName] = {
                            contactInfo: student.contactInfo,
                            children: [],
                            boys: 0,
                            girls: 0
                        };
                    }
                    familyGroups[student.parentsName].children.push({ name: student.name, gender: student.gender });
                    if (student.gender === 'BOYS') {
                        familyGroups[student.parentsName].boys++;
                    } else if (student.gender === 'GIRLS') {
                        familyGroups[student.parentsName].girls++;
                    }
                }
            });

            // Convert familyGroups object to an array for easier sorting and display
            familyGroupingsData = Object.keys(familyGroups).map(parentName => ({
                parentName: parentName,
                contactInfo: familyGroups[parentName].contactInfo,
                childrenCount: familyGroups[parentName].children.length,
                genderMix: `${familyGroups[parentName].boys} Boys, ${familyGroups[parentName].girls} Girls`
            })).sort((a, b) => b.childrenCount - a.childrenCount); // Sort by children count descending

            // Update Summary Cards
            document.getElementById('totalStudents').textContent = totalStudentsCount;
            document.getElementById('maleStudents').textContent = maleStudentsCount;
            document.getElementById('femaleStudents').textContent = femaleStudentsCount;
            document.getElementById('weekendProgram').textContent = weekendProgramCount;
            // The 'irregularStudents' card is not in the user's latest HTML snippet, so I'm commenting out its update.
            // document.getElementById('irregularStudents').textContent = irregularStudentsCount; 

            // Helper function to create chart options with datalabels
            function getChartOptions(titleText, pluginsOptions = {}, scalesOptions = {}) {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: titleText ? true : false,
                            text: titleText
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold'
                            },
                            formatter: (value, context) => {
                                if (showPercentageOnPieDoughnut && (context.chart.config.type === 'pie' || context.chart.config.type === 'doughnut')) {
                                    const sum = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = (sum > 0) ? (value * 100 / sum).toFixed(1) + '%' : '0%';
                                    return percentage;
                                }
                                return value;
                            }
                        },
                        ...pluginsOptions
                    },
                    scales: scalesOptions
                };
            }

            // Destroy existing chart instances before creating new ones to prevent memory leaks and conflicts
            if (genderChartInstance) genderChartInstance.destroy();
            if (programChartInstance) programChartInstance.destroy();
            if (levelChartInstance) levelChartInstance.destroy();
            if (departmentChartInstance) departmentChartInstance.destroy();
            if (levelGenderChartInstance) levelGenderChartInstance.destroy();

            // Gender Distribution Chart
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            genderChartInstance = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Male', 'Female'],
                    datasets: [{
                        data: [genderDistribution.BOYS, genderDistribution.GIRLS],
                        backgroundColor: ['#4F46E5', '#EC4899'],
                        borderWidth: 0
                    }]
                },
                options: getChartOptions('Gender Distribution', {}, { cutout: '70%' })
            });
            document.getElementById('genderInsight').textContent = `The data shows a gender distribution with ${genderDistribution.BOYS} male and ${genderDistribution.GIRLS} female students.`;


            // Program (Department) Distribution Chart
            const departmentLabels = Object.keys(departmentDistribution).sort();
            const departmentData = departmentLabels.map(label => departmentDistribution[label]);
            const programCtx = document.getElementById('programChart').getContext('2d');
            programChartInstance = new Chart(programCtx, {
                type: 'pie',
                data: {
                    labels: departmentLabels,
                    datasets: [{
                        data: departmentData,
                        backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444'], // Add more colors if needed
                        borderWidth: 0
                    }]
                },
                options: getChartOptions('Program Distribution')
            });
            const totalProgramStudents = departmentData.reduce((sum, count) => sum + count, 0);
            const weekendPercentage = totalProgramStudents > 0 ? ((departmentDistribution['WEEKEND'] || 0) / totalProgramStudents * 100).toFixed(1) : '0';
            document.getElementById('programInsight').textContent = `${weekendPercentage}% of students attend the Weekend program. This suggests the Weekend program is a primary offering.`;


            // Level Distribution Chart
            const levelLabels = Object.keys(levelDistribution).sort((a, b) => {
                const order = ['0', '1A', '1B', '1C', '2', '3', '4'];
                return order.indexOf(a) - order.indexOf(b);
            });
            const levelData = levelLabels.map(label => levelDistribution[label]);
            const levelCtx = document.getElementById('levelChart').getContext('2d');
            levelChartInstance = new Chart(levelCtx, {
                type: 'bar',
                data: {
                    labels: levelLabels,
                    datasets: [{
                        label: 'Students',
                        data: levelData,
                        backgroundColor: '#8B5CF6',
                        borderWidth: 0
                    }]
                },
                options: getChartOptions('Class Level Distribution', { legend: { display: false } }, { y: { beginAtZero: true } })
            });
            document.getElementById('levelInsight').textContent = `The student distribution across levels is: ${levelLabels.map((l, i) => `${l}: ${levelData[i]}`).join(', ')}.`;


            // Department Distribution Chart (This is a duplicate of Program Distribution, so I'll reuse the data)
            const departmentCtx = document.getElementById('departmentChart').getContext('2d');
            departmentChartInstance = new Chart(departmentCtx, {
                type: 'doughnut',
                data: {
                    labels: departmentLabels,
                    datasets: [{
                        data: departmentData,
                        backgroundColor: ['#F59E0B', '#6366F1', '#10B981', '#EF4444'],
                        borderWidth: 0
                    }]
                },
                options: getChartOptions('Department Distribution', {}, { cutout: '70%' })
            });
            document.getElementById('departmentInsight').textContent = `The majority of students (${weekendPercentage}%) are in the Weekend department.`;


            // Level by Gender Chart
            const levelGenderLabels = Object.keys(levelGenderDistribution).sort((a, b) => {
                const order = ['0', '1A', '1B', '1C', '2', '3', '4'];
                return order.indexOf(a) - order.indexOf(b);
            });
            const levelGenderBoysData = levelGenderLabels.map(label => levelGenderDistribution[label].BOYS || 0);
            const levelGenderGirlsData = levelGenderLabels.map(label => levelGenderDistribution[label].GIRLS || 0);
            const levelGenderCtx = document.getElementById('levelGenderChart').getContext('2d');
            levelGenderChartInstance = new Chart(levelGenderCtx, {
                type: 'bar',
                data: {
                    labels: levelGenderLabels,
                    datasets: [
                        {
                            label: 'Male',
                            data: levelGenderBoysData,
                            backgroundColor: '#4F46E5'
                        },
                        {
                            label: 'Female',
                            data: levelGenderGirlsData,
                            backgroundColor: '#EC4899'
                        }
                    ]
                },
                options: getChartOptions(
                    'Level Distribution by Gender',
                    {},
                    {
                        x: { stacked: false },
                        y: { stacked: false, beginAtZero: true }
                    }
                )
            });
            document.getElementById('levelGenderInsight').textContent = `Gender distribution across levels shows variations, with specific levels having more boys or girls.`;


            // Populate Family Groupings Table
            const familyTableBody = document.getElementById('familyGroupingsTableBody');
            familyTableBody.innerHTML = ''; // Clear previous data
            if (familyGroupingsData.length > 0) {
                familyGroupingsData.forEach((group, index) => {
                    const row = familyTableBody.insertRow();
                    row.className = index % 2 === 0 ? '' : 'bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${group.parentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${group.contactInfo}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${group.childrenCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${group.genderMix}</td>
                    `;
                });
                document.getElementById('familyInsight').textContent = `The data reveals ${familyGroupingsData.length} families with multiple children enrolled, with the largest family group having ${familyGroupingsData[0].childrenCount} children.`;
            } else {
                familyTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No family data available.</td></tr>`;
                document.getElementById('familyInsight').textContent = `No family grouping data found. Please ensure 'PARENTS NAME' and 'CONTACT INFO' columns are present in your CSV.`;
            }

            // Populate Top Parents Section
            const topParentsContainer = document.getElementById('topParentsContainer');
            topParentsContainer.innerHTML = ''; // Clear previous data
            if (familyGroupingsData.length > 0) {
                familyGroupingsData.slice(0, 6).forEach(parent => { // Show top 6 parents
                    const parentCard = document.createElement('div');
                    parentCard.className = 'bg-indigo-50 rounded-lg p-4 flex items-center';
                    parentCard.innerHTML = `
                        <div class="bg-indigo-100 p-3 rounded-full mr-4">
                            <i class="fas fa-user-tie text-indigo-600"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">${parent.parentName}</h3>
                            <p class="text-sm text-gray-600">${parent.childrenCount} children enrolled</p>
                        </div>
                    `;
                    topParentsContainer.appendChild(parentCard);
                });
                document.getElementById('topParentsInsight').textContent = `Several families have multiple children enrolled, indicating strong family engagement with the institution. The top parent has ${familyGroupingsData[0].childrenCount} children in the program.`;
            } else {
                topParentsContainer.innerHTML = `<div class="bg-gray-50 rounded-lg p-4 text-center text-gray-500 col-span-full">No top parent data available.</div>`;
                document.getElementById('topParentsInsight').textContent = `No top parent data found. Please ensure 'PARENTS NAME' column is present in your CSV.`;
            }

            // Populate Student Data Table with Pagination
            renderStudentTable(studentsData, currentPage);
            setupPagination(studentsData.length);

            // Update Key Insights
            document.getElementById('insightGender').textContent = `The institution has ${maleStudentsCount} male and ${femaleStudentsCount} female students.`;
            document.getElementById('insightFamily').textContent = `There are ${familyGroupingsData.length} families with multiple children, with the largest having ${familyGroupingsData.length > 0 ? familyGroupingsData[0].childrenCount : 0} children.`;
            document.getElementById('insightProgram').textContent = `The Weekend program has ${weekendProgramCount} enrollments, making it the most popular program.`;
            document.getElementById('insightLevel').textContent = `There are ${irregularStudentsCount} irregular students. The most popular levels are ${Object.keys(levelDistribution).filter(k => levelDistribution[k] === Math.max(...Object.values(levelDistribution))).join(', ')}.`;

            // Update last updated timestamp
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        /**
         * Renders the student data table for the current page.
         * @param {Array<Object>} data - The full array of student objects.
         * @param {number} page - The current page number to display.
         */
        function renderStudentTable(data, page) {
            const tableBody = document.getElementById('studentDataTableBody');
            tableBody.innerHTML = ''; // Clear previous data

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No student data available.</td></tr>`;
                document.getElementById('paginationInfo').textContent = `Showing 0 to 0 of 0 entries`;
                document.getElementById('prevPageButton').disabled = true;
                document.getElementById('nextPageButton').disabled = true;
                document.getElementById('paginationButtons').innerHTML = '';
                return;
            }

            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = data.slice(start, end);

            paginatedData.forEach((student, index) => {
                const row = tableBody.insertRow();
                row.className = index % 2 === 0 ? '' : 'bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${start + index + 1}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${student.name}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${student.level}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${student.gender}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${student.department}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${student.parentsName}</td>
                `;
            });

            document.getElementById('paginationInfo').textContent = `Showing ${start + 1} to ${Math.min(end, data.length)} of ${data.length} entries`;
        }

        /**
         * Sets up pagination controls.
         * @param {number} totalItems - Total number of items (students).
         */
        function setupPagination(totalItems) {
            totalPages = Math.ceil(totalItems / rowsPerPage);
            const paginationButtonsContainer = document.getElementById('paginationButtons');
            paginationButtonsContainer.innerHTML = ''; // Clear existing buttons

            document.getElementById('prevPageButton').disabled = currentPage === 1;
            document.getElementById('nextPageButton').disabled = currentPage === totalPages || totalPages === 0;

            // Generate page number buttons
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `px-3 py-1 rounded-md text-sm ${i === currentPage ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}`;
                button.addEventListener('click', () => {
                    currentPage = i;
                    renderStudentTable(studentsData, currentPage);
                    setupPagination(studentsData.length); // Re-render pagination to update active button
                });
                paginationButtonsContainer.appendChild(button);
            }
        }

        // Event listeners for pagination buttons
        document.getElementById('prevPageButton').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderStudentTable(studentsData, currentPage);
                setupPagination(studentsData.length);
            }
        });

        document.getElementById('nextPageButton').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderStudentTable(studentsData, currentPage);
                setupPagination(studentsData.length);
            }
        });


        /**
         * Saves the provided raw CSV data string to Firestore.
         * @param {string} data - The raw CSV data string to save.
         */
        async function saveDataToFirestore(data) {
            showLoading(true);
            displayMessage('Saving data to the cloud...', 'orange');
            try {
                await setDoc(studentDataDocRef, { csvData: data, timestamp: new Date().toISOString() });
                displayMessage('Data saved successfully!', 'green');
            } catch (error) {
                console.error("Error writing document:", error);
                displayMessage('Error saving data. Please try again.', 'red');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Sets up a real-time listener for student data from Firestore.
         * This function is called after successful authentication.
         */
        function setupFirestoreListener() {
            showLoading(true);
            displayMessage('Fetching latest data...', 'gray');
            onSnapshot(studentDataDocRef, (docSnap) => {
                showLoading(false);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && data.csvData) {
                        currentRawData = data.csvData;
                        studentsData = parseStudentData(currentRawData);
                        if (studentsData.length > 0) {
                            renderDashboard(studentsData); // Render the full dashboard
                            displayMessage('Data updated in real-time!', 'green');
                        } else {
                            displayMessage('No valid student data found in the cloud document. Please upload a valid CSV.', 'red');
                            renderDashboard([]); // Render empty dashboard if no valid data
                        }
                    } else {
                        // Document exists but has no csvData, possibly a new document
                        displayMessage('No student data found in the cloud. Upload a CSV to get started!', 'orange');
                        renderDashboard([]); // Render empty dashboard if no CSV data is found
                    }
                } else {
                    // Document does not exist, it's the first time
                    displayMessage('No student data found in the cloud. Upload a CSV to get started!', 'orange');
                    renderDashboard([]); // Render empty dashboard if document doesn't exist
                }
            }, (error) => {
                showLoading(false);
                console.error("Error listening to document:", error);
                displayMessage('Error fetching real-time updates. Check console for details (e.g., Firebase security rules).', 'red');
            });
        }

        /**
         * Handles Firebase authentication and then sets up the Firestore listener.
         */
        async function authenticateAndLoad() {
            showLoading(true);
            displayMessage('Authenticating...', 'gray');
            try {
                // __initial_auth_token is specific to the Canvas environment.
                // On GitHub Pages, we'll rely on anonymous sign-in.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                document.getElementById('userIdDisplay').textContent = currentUserId;
                console.log("Authenticated as:", currentUserId);
                setupFirestoreListener(); // Setup listener after auth
            } catch (error) {
                console.error("Firebase authentication failed:", error);
                displayMessage("Authentication failed. Please ensure your Firebase API keys are correctly configured in the code and services are enabled in Firebase console.", 'red');
                showLoading(false);
            }
        }

        // Event listener for file input change
        document.getElementById('loadCsvButton').addEventListener('click', () => {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];

            if (file) {
                if (file.type !== 'text/csv') {
                    displayMessage('Please upload a CSV file.', 'red');
                    return;
                }

                displayMessage('Reading file...', 'orange');
                showLoading(true);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const newRawData = e.target.result;
                        const parsedStudents = parseStudentData(newRawData);
                        if (parsedStudents.length > 0) {
                            // Save the new data to Firestore
                            await saveDataToFirestore(newRawData);
                            // The onSnapshot listener will then trigger renderDashboard with the new data
                        } else {
                            displayMessage('No valid student data found in the CSV. Not saving to cloud.', 'red');
                        }
                    } catch (error) {
                        console.error("Error processing CSV:", error);
                        displayMessage('Error processing file. Please check console for details.', 'red');
                    } finally {
                        showLoading(false);
                    }
                };
                reader.onerror = () => {
                    displayMessage('Error reading file.', 'red');
                    showLoading(false);
                };
                reader.readAsText(file);
            } else {
                displayMessage('Please select a CSV file to upload.', 'red');
            }
        });

        // Initial render of the dashboard with sample data, then authenticate and load from Firestore
        studentsData = parseStudentData(currentRawData);
        renderDashboard(studentsData);
        authenticateAndLoad();
    </script>
</body>
</html>
